generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String                @id @default(cuid())
  email         String                @unique
  phone         String?               @unique
  passwordHash  String?
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  address       String?
  avatarUrl     String?
  budgetMax     Int?
  budgetMin     Int?
  city          String?
  country       String?
  dateOfBirth   DateTime?
  fullName      String?
  gender        String?
  loyaltyPoints Int                   @default(0)
  role          UserRoleEnum          @default(CUSTOMER)
  aiRequestLogs AiRequestLog[]
  auditLogs     AuditLog[]
  carts         Cart[]
  notifications Notification[]
  accounts      OAuthAccount[]
  orders        Order[]
  quizResults   QuizResult[]
  reviews       Review[]
  sessions      Session[]
  preferences   UserScentPreference[]
}

model OAuthAccount {
  id                String    @id @default(cuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  user              User      @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  refreshToken   String   @unique
  userAgent      String?
  ipAddress      String?
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id])
}

/// Scent & preference models
model ScentFamily {
  id          Int                   @id @default(autoincrement())
  name        String                @unique
  description String?
  products    Product[]
  preferences UserScentPreference[]
}

model ScentNote {
  id          Int                   @id @default(autoincrement())
  name        String
  type        ScentNoteType
  description String?
  products    ProductScentNote[]
  preferences UserScentPreference[]

  @@unique([name, type])
}

model UserScentPreference {
  id            Int          @id @default(autoincrement())
  userId        String
  scentFamilyId Int?
  noteId        Int?
  intensity     Int?
  note          ScentNote?   @relation(fields: [noteId], references: [id])
  scentFamily   ScentFamily? @relation(fields: [scentFamilyId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
}

model QuizResult {
  id              String   @id @default(cuid())
  userId          String
  gender          String?
  occasion        String?
  budgetMin       Int?
  budgetMax       Int?
  preferredFamily String?
  longevity       String?
  createdAt       DateTime @default(now())
  recommendation  String?
  user            User     @relation(fields: [userId], references: [id])
}

/// Product & catalog models
model Brand {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  products    Product[]
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  products    Product[]
}

model Product {
  id            String             @id @default(cuid())
  name          String
  slug          String             @unique
  brandId       Int
  categoryId    Int?
  scentFamilyId Int?
  description   String?
  gender        String?
  longevity     String?
  concentration String?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  brand         Brand              @relation(fields: [brandId], references: [id])
  category      Category?          @relation(fields: [categoryId], references: [id])
  scentFamily   ScentFamily?       @relation(fields: [scentFamilyId], references: [id])
  variants      ProductVariant[]
  images        ProductImage[]
  notes         ProductScentNote[]
  reviews       Review[]
  reviewSummary ReviewSummary?
}


model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  name      String   // e.g. "5ml", "10ml", "50ml", "100ml"
  sku       String?  @unique
  price     Int
  stock     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems CartItem[]
  orderItems OrderItem[]

  @@index([productId])
}


model ProductImage {
  id        Int      @id @default(autoincrement())
  productId String
  url       String
  publicId  String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductScentNote {
  productId String
  noteId    Int
  note      ScentNote @relation(fields: [noteId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@id([productId, noteId])
}

/// Cart & order & payment & shipping
model Cart {
  id        String     @id @default(cuid())
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
}

model CartItem {
  id        Int     @id @default(autoincrement())
  cartId    String
  variantId String
  quantity  Int     @default(1)

  cart      Cart           @relation(fields: [cartId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
}


model Order {
  id              String               @id @default(cuid())
  code            String               @unique
  userId          String?
  totalAmount     Int
  discountAmount  Int                  @default(0)
  finalAmount     Int
  status          OrderStatus          @default(PENDING)
  paymentStatus   PaymentStatus        @default(PENDING)
  shippingAddress String?
  phone           String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  promotions      AppliedPromotion[]
  user            User?                @relation(fields: [userId], references: [id])
  items           OrderItem[]
  statusHistory   OrderStatusHistory[]
  payments        Payment[]
  shipments       Shipment[]
}

model OrderItem {
  id         Int     @id @default(autoincrement())
  orderId    String
  variantId  String
  unitPrice  Int
  quantity   Int
  totalPrice Int

  order      Order          @relation(fields: [orderId], references: [id])
  variant    ProductVariant @relation(fields: [variantId], references: [id])
}


model OrderStatusHistory {
  id        Int         @id @default(autoincrement())
  orderId   String
  status    OrderStatus
  note      String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id])
}

model Payment {
  id              String          @id @default(cuid())
  orderId         String
  provider        PaymentProvider
  amount          Int
  status          PaymentStatus   @default(PENDING)
  transactionId   String?
  providerRawData String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  order           Order           @relation(fields: [orderId], references: [id])
}

model Shipment {
  id              String           @id @default(cuid())
  orderId         String
  provider        ShippingProvider
  trackingCode    String?
  fee             Int?
  status          ShipmentStatus   @default(PENDING)
  address         String?
  rawProviderData String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  order           Order            @relation(fields: [orderId], references: [id])
}

model PromotionCode {
  id              String                @id @default(cuid())
  code            String                @unique
  description     String?
  discountType    PromotionDiscountType
  discountValue   Int                   // Giá trị giảm (số tiền hoặc %)
  minOrderAmount  Int?                  // Giá trị đơn hàng tối thiểu
  maxDiscount     Int?                  // Giảm tối đa (đối với PERCENTAGE)
  usageLimit      Int?                  // Số lần sử dụng tối đa
  usedCount       Int                   @default(0)
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  appliedOrders   AppliedPromotion[]
}

model AppliedPromotion {
  id              String        @id @default(cuid())
  orderId         String
  discountAmount  Int
  promotionCodeId String
  order           Order         @relation(fields: [orderId], references: [id])
  promotionCode   PromotionCode @relation(fields: [promotionCodeId], references: [id])
}

/// Reviews & AI summarization
model Review {
  id        Int      @id @default(autoincrement())
  userId    String
  productId String
  rating    Int
  title     String?
  content   String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model ReviewSummary {
  productId String   @id
  summary   String
  sentiment String?
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
}

/// Notifications
model Notification {
  id        String              @id @default(cuid())
  userId    String?
  channel   NotificationChannel
  type      String
  title     String
  content   String
  data      String?
  isRead    Boolean             @default(false)
  createdAt DateTime            @default(now())
  user      User?               @relation(fields: [userId], references: [id])
}

/// AI orchestration & logs
model AiRequestLog {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  request   String
  response  String?
  status    String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

/// Audit & system
model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  metadata  String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}



enum UserRoleEnum {
  CUSTOMER
  STAFF
  ADMIN
}

enum ScentNoteType {
  TOP
  MIDDLE
  BASE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentProvider {
  VNPAY
  MOMO
  COD
  PAYOS
  VIETQR
}

enum ShippingProvider {
  GHN
  GHTK
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum PromotionDiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
}
